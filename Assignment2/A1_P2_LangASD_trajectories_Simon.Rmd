---
title: "Assignment 1 - Language Development in ASD - part 2"
author: "Simon M. N."
date: "05/12 2018"
output: html_document
---
    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# you could optionally set include = TRUE globally while working on the exercise and then just change it to include = FALSE before you hand in
# knitr::opts_chunk$set(include = FALSE)
```

# Template for the hand-in
### Structure of the code chunks

Basic stuff:
- Loading the libraries
- Setting the directory and loading the data
- Look at the data (which variables are there? Are they in the right format?) and describe the participants (by diagnosis)

We will try to answer three questions:
    
- Do children with ASD develop language differently from non-ASD children?
- Do parents speak differently to children with ASD than to non-ASD ones?
- Which variables should we use to best explain the child linguistic performance?

### Loading the relevant libraries

Load necessary libraries : what will you need?

- e.g. something to plot with
- e.g. mixed effects models

```{r Load Libraries, include = FALSE}
#Loading packages
library(pacman)
p_load(ggplot2,lme4,tidyverse,dplyr,MuMIn,effects)
```

### Define your working directory and load the data
If you created a project for this class and opened this Rmd file from within that project, your working directory is your project directory.

If you opened this Rmd file outside of a project, you will need some code to find the data:
- Create a new variable called locpath (localpath)
- Set it to be equal to your working directory
- Move to that directory (setwd(locpath))
- Load the data you saved last time (use read_csv(fileName))

If your're in a project, just put the data in the project folder and you're good to go! (Or make a data subfolder to keep it tidy around here)
```{r Load Data, include = FALSE}
# Setting WD and loading the data
setwd("C:/Users/slmoni/Documents/Uni/Experimental Methods III/R-stuff/Assignment2")
data<-read.csv("ADSFinal_Simon.csv",stringsAsFactors = F)

# Changing diagnosis and visit to a factor to avoid issues later
data$Diagnosis <-as.factor(data$Diagnosis)
data$VISIT <-as.factor(data$VISIT)
```

### Characterize the participants (Exercise 1)

Identify relevant variables: participants demographic characteristics, diagnosis, ADOS, Verbal IQ, Non Verbal IQ, Visit, Number of words used, Number of unique words used, length of utterance in both child and parents.

Make sure the variables are in the right format.

Describe the characteristics of the two groups of participants and whether the two groups are well matched.

```{r descriptive stats, include = FALSE}
# Removing NA's
data<-data[complete.cases(data[ , 14]),]

# Making three dataframs with only the first visit and for only the ASD and TD group
visit1<- filter(data, VISIT==1)
visit1ASD<- filter(data, VISIT==1 & Diagnosis=='ASD')
visit1TD<- filter(data, VISIT==1 & Diagnosis=='TD')

#Diagnosis comparison
table(visit1$Diagnosis)
#Gender comparison
table(visit1ASD$Gender)
table(visit1TD$Gender)
#Age comparison
t.test(visit1$Age ~ visit1$Diagnosis)
sd(visit1ASD$Age)
sd(visit1TD$Age)
#Ethnicity comparison
table(visit1ASD$Ethnicity)
table(visit1TD$Ethnicity)
#nonverbalIQ comparison
t.test(visit1$nonVerbalIQ ~ visit1$Diagnosis)
sd(visit1ASD$nonVerbalIQ)
sd(visit1TD$nonVerbalIQ)
#verbalIQ comparison
t.test(visit1$verbalIQ ~ visit1$Diagnosis)
sd(visit1ASD$verbalIQ)
sd(visit1TD$verbalIQ)
```

[REPORT THE RESULTS]
I first removed the NAs form the list to get a more accurate assessment of the two groups, since some of the children in the dataset only have NAs and therefor have no impact on the analyses. I look only at the children at visit 1 since we are interested in diffrences at the beginning of the experiment and we expect diffrences to occur later in the experiment
First looking at the size of the two groups. Number of children with ASD was 29 and number of children with TD is 31. That is simmilar size groups and we should not run into any issues.
Looking at gender within the ASD group there was 25 females and 4 males and in the TD group there was 25 females and 6 males. Again very similar and it should not cause any issues. One thing to note is that this is not an accurate representation for the real world population, so gernalasation to the real world will be weaker, considering males and females may learn language in diffrenret ways and be effect by ASD in diffrent ways.
A Welch two-sample t-test is run on the average age of the two groups. It was found that there was a significant diffrence between the average age of ASD (M=33, SD=5.59) and the average age of TD (M=20.38, SD=1.51), t(31.82)=11.76 p < 0.001. This may cause some issues since children may learn language at different rates depending on there age. This diffrence is likely due to the difficulty of diagnosing ASD in young children.
Ethnicity was also counted. However, the majority of the children where white. Though the ADS group was more diverse with 7 non-whites where the TD group only had 1 non-white. It is however not really possible to say if this will have an impact, since ethnicity is likly not a good predictor of linguistic development (Unless you want to be really controversial). Ethnicity can correlate with socioeconomic status which can have an impact on linguistic development. It is, however, impossible to say much form ethnicity.

Out of interrest a Welch two-sample t test was run on non-verbal IQ and verbal IQ. Though it would be a fair assumption that there would be a diffrences between the two groups due to diagnosis.
Interestingly there was no significant diffrence between the ADS groups non-verbal IQ (M=26.9, SD=5.68) and the TD groups non-verbal IQ (M=26.19, SD=3.21), t(43.6)=0.59 p > 0.05.
Nither was there a significant diffrence between ADS groups verbal IQ (M=17.31, SD=7.45) and the TD groups verbal IQ (M=20.35, SD=5.15), t(49.44)=-1.83 p > 0.05.
I'm not completly sure why this is, however, I think it might be because the non-verbal IQ and verbal IQ was accesed at visit 1 where both groups was at the same stage in linguistic development.

## Let's test hypothesis 1: Children with ASD display a language impairment  (Exercise 2)

### Hypothesis: The child's MLU changes: i) over time, ii) according to diagnosis

Let's start with a simple mixed effects linear model

Remember to plot the data first and then to run a statistical test.
- Which variable(s) should be included as fixed factors?
- Which variable(s) should be included as random factors?

```{r ex2, include = FALSE}
###Working with childs data
#Making a boxplot of the data to assess the data
boxplot(CHI_MLU ~ Diagnosis*VISIT, col=c("white","lightgray"),data)

#Makeing a lineplot of the data to assess the data
line_plot <- ggplot(data, aes(VISIT,CHI_MLU, color = Diagnosis)) 
line_plot + 
  geom_violin () +
  geom_jitter(height = 0, width = 0.1) +
  stat_summary(fun.y = mean, geom = "point") +
  stat_summary(fun.y = mean, geom = "line",aes(group = Diagnosis)) + 
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.5, aes(group = Diagnosis), position = position_dodge2()) + 
  scale_color_manual(values=c("goldenrod1","dodgerblue")) +
  ggtitle("Lineplot of Raw Data")+
  xlab("Visit") + ylab("Child MLU")

#Making a simple linear mixed effects model. Model 1
data$VISIT <-as.integer(data$VISIT)
languageModel = lmer(CHI_MLU ~ Diagnosis * VISIT + (1+VISIT|SUBJ), data=data,REML=FALSE)
summary(languageModel)
```

How would you evaluate whether the model is a good model?

```{r ex2 evaluate, include = FALSE}
## Assessing model 1

# First with r squared
r.squaredGLMM(languageModel)

# Then with an anova
languageNull = lmer(CHI_MLU ~ VISIT + (1+VISIT|SUBJ), data=data, REML=FALSE)
anova(languageNull,languageModel)

#Assumptions testing
plot(residuals(languageModel))
qqnorm(residuals(languageModel))
plot(fitted(languageModel),residuals(languageModel))^2
```

Not too good, right? Let's check whether a growth curve model is better.
Remember: a growth curve model assesses whether changes in time can be described by linear, or quadratic, or cubic (or... etc.) components.
First build the different models, then compare them to see which one is better

```{r ex2 growth curve, include = FALSE}
#Making a quadratic mixed effects model. Model 2
languageModel2 = lmer(CHI_MLU ~ Diagnosis * VISIT + I(VISIT^2) + (1+VISIT+ I(VISIT^2)|SUBJ), data=data, REML=FALSE)
summary(languageModel2)
# Assessing model 2
r.squaredGLMM(languageModel2)
languageNull2 = lmer(CHI_MLU ~ VISIT + I(VISIT^2) + (1+VISIT+ I(VISIT^2)|SUBJ), data=data, REML=FALSE)
anova(languageNull2,languageModel2)

#Making a cubic mixed effects model. Model 3
model_cubic <- lmer(CHI_MLU ~ VISIT * Diagnosis + I(VISIT^2) + I(VISIT^3)  + (1+VISIT + I(VISIT^2) + I(VISIT^3)|SUBJ), data = data, REML=FALSE)
# Assessing model 3
summary(model_cubic)
r.squaredGLMM(model_cubic)

#Making a "what ever this is called" mixed effects model. Model 4
model_quadrouble <- lmer(CHI_MLU ~ VISIT * Diagnosis + I(VISIT^2) + I(VISIT^3) +I(VISIT^4)+ (1+VISIT + I(VISIT^2) + I(VISIT^3) + I(VISIT^4)|SUBJ), data = data, REML=FALSE)
# Assessing model 4
summary(model_quadrouble)
r.squaredGLMM(model_quadrouble)

# Plot of the child MLU model (shamelessly stolen with comments and all :P) (not so much anymore)
ee <- effect(c("Diagnosis","VISIT"),languageModel2) 
theme_set(theme_bw())
ggplot(as.data.frame(ee), aes(VISIT,fit,colour=Diagnosis,fill=Diagnosis))+
    geom_line()+
    geom_point(data=data, aes(x=VISIT, y=CHI_MLU), position = position_dodge2(width=0.5)) +
     ## colour=NA suppresses edges of the ribbon
    geom_ribbon(colour=NA,alpha=0.1,
                            aes(ymin=lower,ymax=upper))+
  labs(title = "Diagnosis as predictor of child MLU development", x = "Visit", y = "MLU")

#Assumptions testing
plot(residuals(languageModel2))
qqnorm(residuals(languageModel2))
plot(fitted(languageModel2),residuals(languageModel2))^2

plot(residuals(model_cubic))
qqnorm(residuals(model_cubic))
plot(fitted(model_cubic),residuals(model_cubic))^2

plot(residuals(model_quadrouble))
qqnorm(residuals(model_quadrouble))
plot(fitted(model_quadrouble),residuals(model_quadrouble))^2
```

Exciting right?
Now it's time to report our results.
Remember to report:
- the estimates for each predictor (beta estimate, standard error, p-value)
- A plain word description of the results
- A plot of your best model's predictions
Linguistic development of children MLU is affected by ... 

[REPORT THE RESULTS]
A quadratic mixed effects analysis was preformed on the linguistic development of children MLU, to find ASD and TD impact on development MLU in children. With the fixed effctes being an interaction effct between diagnosis and number of visits, and visits being quadratic. Random effects was intercepts and slopes by subjects for child MLU. 
Assumptions of homoscedasticity and normality was tested and no violation was found.
The P-value obtained by likelihood ratio test.
The model showed that diagnosis significantly predict child MLU development, when going form ASD to TD (bata=0.25, SE=0.04, t(12)=6.73, p < 0.001).
This shows that, according to our model, a child with TD MLU increase by 0.25 more for each visit then a child with ASD.
This can also be seen in the figure for "Diagnosis as predictor of child MLU development". Children with ASD MLU increases much more slowly. Looking at the lineplot of the data the models also nicely seem to follow the data.
What also be seen form the plot of the model, is that MLU is starting to decrease for ADS children. This shows the weakness of the quadratic model, since it is fair to assume that childrens MLU does not at the very least decrease after a few years. So while the quadratic model may predict the MLU development for this periode in childhood, it does not pridict MLU development for children later in development.

## Let's test hypothesis 2: Parents speak equally to children with ASD and TD  (Exercise 3)

### Hypothesis: Parental MLU changes: i) over time, ii) according to diagnosis

```{r ex3, include = FALSE}
###Working with mothers data
#Making a boxplot of the data to assess the data
boxplot(MOT_MLU ~ Diagnosis*VISIT, col=c("white","lightgray"),data)

#Makeing a lineplot of the data to assess the data
data$VISIT <-as.factor(data$VISIT)
line_plot <- ggplot(data, aes(VISIT,MOT_MLU, color = Diagnosis)) 
line_plot + 
  geom_violin () +
  geom_jitter(height = 0, width = 0.1) +
  stat_summary(fun.y = mean, geom = "point") +
  stat_summary(fun.y = mean, geom = "line",aes(group = Diagnosis)) + 
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.2, aes(group = Diagnosis)) + 
  scale_color_manual(values=c("goldenrod1","dodgerblue"))+
  ggtitle("Lineplot of Raw Data")+
  xlab("Visit") + ylab("Mother MLU")

data$VISIT <-as.integer(data$VISIT)

#Making a quadratic mixed effects model. Model 5
languageModelMot = lmer(MOT_MLU ~ Diagnosis * VISIT + I(VISIT^2) + (1+VISIT+ I(VISIT^2)|SUBJ), data=data, REML=FALSE)
summary(languageModelMot)
# Assessing model 4
r.squaredGLMM(languageModelMot)
languageNullMot = lmer(MOT_MLU ~ VISIT + I(VISIT^2) + (1+VISIT+ I(VISIT^2)|SUBJ), data=data, REML=FALSE)
anova(languageNullMot,languageModelMot)

# Plot of the parent MLU model (shamelessly stolen with comments and all :P) (not so much anymore)
ee <- effect(c("Diagnosis","VISIT"),languageModelMot) 
theme_set(theme_bw())
ggplot(as.data.frame(ee),
       aes(VISIT,fit,colour=Diagnosis,fill=Diagnosis))+
    geom_line()+
    geom_point(data=data, aes(x=VISIT, y=MOT_MLU), position = position_dodge2(width=0.5)) +
     ## colour=NA suppresses edges of the ribbon
    geom_ribbon(colour=NA,alpha=0.1,
                            aes(ymin=lower,ymax=upper))+
  labs(title = "Diagnosis as predictor of mother MLU increase", x = "Visit", y = "MLU") 

#Assumptions testing
plot(residuals(languageModelMot))
qqnorm(residuals(languageModelMot))
plot(fitted(languageModelMot),residuals(languageModelMot))^2
```

[REPORT THE RESULTS]
A quadratic mixed effects analysis was preformed on the increase in mother MLU, to find ASD and TD impact on incease of MLU for mothers. With the fixed effctes being an interaction effct between diagnosis and number of visits, and visits being quadratic. Random effects was intercepts and slopes by subjects for mother MLU. 
Assumptions of homoscedasticity and normality was tested and no violation was found.
The P-value obtained by likelihood ratio test.
The model showed that diagnosis significantly predict mother MLU increase, when going form ASD to TD (bata=0.03, SE=0.035, t(12)=0.857, p < 0.001).
It is worth noting tha the effect was alot smaller then on the childrens MLU.
This shows that, according to our model, for a mother with TD child MLU increase by 0.03 more for each visit then a mother with a ASD child.
Looking at the figure "Diagnosis as predictor of Mother MLU increase" it is clear the there is very little difference between increase in mother MLU for ASD and TD. Though it is clear that mothers start at different MLU. This can also be seen in the lineplot of the data.

### Adding new variables (Exercise 4)

Your task now is to figure out how to best describe the children linguistic trajectory. The dataset contains a bunch of additional demographic, cognitive and clinical variables (e.g.verbal and non-verbal IQ). Try them out and identify the statistical models that best describes your data (that is, the children's MLU). Describe how you selected the best model and send the code to run the model to Malte (au540041@post.au.dk).


```{r ex4, include = FALSE}
#You know the deal by now :|
boxplot(types_CHI ~ Diagnosis*VISIT, col=c("white","lightgray"),data)
languageModelTest = lmer(types_CHI ~ Diagnosis * VISIT + I(VISIT^2) + (1+VISIT+ I(VISIT^2)|SUBJ), data=data, REML=FALSE)
summary(languageModelTest)
r.squaredGLMM(languageModelTest)
languageModelTestNull = lmer(types_MOT ~ VISIT + I(VISIT^2) + (1+VISIT+ I(VISIT^2)|SUBJ), data=data, REML=FALSE)
anova(languageModelTestNull,languageModelTest)
```

[REPORT THE RESULTS]
I p-hac... I mean explored the data to try to find a better prediction. I tried to use with token and type as outcome variables and tried to use ADOS, verbal IQ and non-verbal IQ as a preditor variable, however, I was unable to find a predictor that explain the data better then diagnosis for child MLU. 
