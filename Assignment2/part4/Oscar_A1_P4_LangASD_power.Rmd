---
title: "Assignment 1 - Language Development in ASD - part 4"
author: "Riccardo Fusaroli"
date: "August 10, 2017"
output: html_document
---


## Welcome to the fourth exciting part of the Language Development in ASD exercise

In this exercise we will assess how many participants we would need to adequately replicate our findings (ensuring our sample size is adequate, our alpha at 0.05 and our beta at 0.8).

### Exercise 1

How much power does your study have (if your model estimates are quite right)?
- [GitHub]Load your dataset, fit your favorite model, assess power for your main effects and interactions of interest.
- Report the power analysis and comment on what you can (or cannot) use its estimates for.

### Exercise 2

How would you perform a more conservative power analysis?
- Identify and justify a minimum effect size for each of your relevant effects
- [GitHub] take the model from exercise 1 and replace the effects with the minimum effect size that you'd accept.
- [GitHub] assess the power curve by Child.ID, identifying an ideal number of participants to estimate each effect
- [GitHub] if your power estimates do not reach an acceptable threshold simulate additional participants and repeat the previous analysis
- Report the power analysis and comment on what you can (or cannot) use its estimates for.


### Exercise 3

Assume you have only the resources to collect 30 kids (15 with ASD and 15 TDs). Identify the power for each relevant effect and discuss whether it's worth to run the study and why.
```{r}
library(lme4)
library(simr)
library(lmerTest)

training = read.csv("train.csv", stringsAsFactors = F)

#Removing all NA values from my dataset 
training = training[complete.cases(training[,14]),]
training = training[complete.cases(training[,6]),]

#Double checking to see if i have any NA values left. 
apply(training, 2, function(x) any(is.na(x)))





```

```{r}

#Creating my favourite model.
model = lmer(CHI_MLU ~ ADOS * Age + (1+Age|SUBJ), data = training)
summary(model)



powerSim(model,simr::fixed('ADOS:Age',method='t'),nsim=1000) #Testing the power for interaction effect
powerSim(model,simr::fixed('Age',method='t'),nsim=1000) #Testing the power for one of my main effects
powerSim(model,simr::fixed('ADOS',method='t'),nsim=1000) #Testing the power for my other main effect.





```
#1 How much power does my study have?

Testing the power for my linear mixed effect model: CHI_MLU ~ ADOS * Age + (1+Age|SUBJ)

Using 1000 simulations, the observed power for the estimate of the main effect 'Age' (0.090) is calculated to 100% with confidence intervals ranging from 99.63-100.
The observed power for for the estimate of the main effect 'ADOS'  (0.078) is calculated to 98% with a confidence interval of 96.93-98.77. 
The observed power for the estimate of the interaction effect 'ADOS*Age' (-0.0048) in my model is calculated to 100%, with confidence intervals ranging from 99.63-100.0. The power analysis indicates that the estimates are highly reliable and that our study is overpowered. 

The interaction effect can be interpreted as each time ADOS score is increased by 1, the slope for CHI_MLU decrease by -0.0048 per month. After 24 months, this results in a difference of (24*-0.0048) -0.1152 CHI_MLU. 
```{r}
#Identify a minimum effect size

#Making a new dataset.
norm_training = training

#Standardizing my ADOS and Age values for my new dataset.
ADOS_S = (training$ADOS - mean(training$ADOS)) / sd(training$ADOS)
Age_S = (training$Age - mean(training$Age)) / sd(training$Age)
CHI_MLU_S = (training$CHI_MLU - mean(training$CHI_MLU)) / sd(training$CHI_MLU)

norm_training$ADOS = ADOS_S
norm_training$Age = Age_S
norm_training$CHI_MLU = CHI_MLU_S


#Creating a standardized/normalized model which will give me Cohen's d for my effect size. Has to be done like this because my variables ADOS is 'continuous'.
norm_model = lmer(CHI_MLU ~ ADOS * Age + (1+Age|SUBJ), data = norm_training)
summary(norm_model) #If i understand this correctly, the Cohens d for my effect size is the coefficient for my interaction effect in the standardized model (0.38309). 
#Cohen suggests that 0.2 is a small effect size. In order to find a minimum effect size for my actual model i can look a the relation between the Cohens d for my effect size and a Cohens d of 0.2. 

0.38309 / 0.2 # 1.91545. The Cohens d of my effect size is 1.91545 times larger than the minimum Cohens d for a > small effect.

-0.0048 / 1.91545 # = -0.002505939 This is the minimum effect size i would consider for my model.



#Making a power curve with my minimum effect size in order to estimate minimum required participants for replication of minimum effect.
fixef(model)["ADOS:Age"] = -0.002505939
powerCurveV = powerCurve(model, fixed("ADOS:Age", method = 't'),along="SUBJ", nsim=200)

powerCurveV

plot(powerCurveV) # From the power curve it seems that the minimum effect needs an estimated ~28 particpants before reaching 80% power. 



```
#2 Conservative Power Analysis

In order to investigate the minimum amount of participants required for future well-powered (at or above 80%) replications of this experiment, a minimum effect size was found using Cohens d. Given Cohens d at .2, the minimum effect size was found to be = -0.0025. The minimum effect size should be understood as the minimum size of the interaction effect proposed by the linear mixed effect model mentioned earlier.  Any effects lower than the minimum effect would be un-interesting to investigate for any future studies. The minimum effect size is not the 'real effect size'.

I am not sure if it is relevant for me to define a minimum effect size for my main effects when my model includes an interaction effect.

The power curve indicates that for replications of the study, a minimum of 28 participants is required to find the minimum effect size.  

```{r}

powerCurveC = powerCurve(model, fixed("Age", method = 't'),along="SUBJ", breaks= c(15:30))

powerCurveC

powerCurveD = powerCurve(model, fixed("ADOS", method = 't'),along="SUBJ", breaks= c(15:30))

powerCurveD

#testing the interaction effects power
powerCurveB = powerCurve(model, fixed("ADOS:Age", method = 't'),along="SUBJ", breaks= c(15:30))


powerCurveB

plot(powerCurveB)

```

# Would a study with 30 participants be worth running?

It seems that the power reaches 75% at 30 participants with confidence intervals at 73.02 - 78.43, thus our coefficients would be unreliable compared to the standard 80% power requirement. This is ofcourse still on the premise of our minimum effect size. Note that the power is estimated to reach > 80% when the participant number reaches 31.

A huge problem with my model is the variable Age. Presumably the data is biased, since the participants were grouped by amount of tokens. A better model may be tokens ~ Age. 




```{r}


